---
title: "Data Wrangling"
subtitle: "STAT 231 Blog Project"
author: "Gloria Wu, Justyce Williams, Ben Snyderman"
date: today
format: pdf
linestretch: 1.15
highlight-style: arrow
---

```{r}
#| label: setup
#| include: FALSE

knitr::opts_chunk$set(
  # display code as types
  tidy = FALSE, 
  # slightly smaller code font
  size = "small",
  # do not display messages in PDF
  message = FALSE,
  # set default figure width and height
  fig.width = 5, fig.height = 3) 

# improve digit and NA display 
options(scipen = 1, knitr.kable.NA = '')

# load packages
library(tidyverse)
library(rvest)
library(ggplot2)
library(stringr)
library(robotstxt)
library(tidyr)
library(dplyr)
library(spotifyr)
library(tidytuesdayR)
library(httr)
library(jsonlite)
```

## Variables


## Wrangling

```{r}
#| label: load & basic wrangling

## check if we can scrape
paths_allowed("https://www.billboard.com/charts/hot-100/")
paths_allowed("https://genius.com")
paths_allowed("https://spotify.com")

## tidy tuesday spotify data
spotify_songs <- readRDS("data/tt_spotify_songs.Rds")
```

```{r}
#| label: (attempt) load spotify data

## spotify credentials
Sys.setenv(SPOTIFY_CLIENT_ID = "03faef051fef46ed8ecc6f2153a55206")
Sys.setenv(SPOTIFY_CLIENT_SECRET = "475255efd20c45f88e50275490895841")

## tokens necessary for use 
access_token <- get_spotify_access_token()

## get playlist details
playlist <- get_playlist_tracks("6UeSakyzhiEt4NB3UAd6NQ")

## get individual track audio features
# track_ids <- playlist$track.id
# track_audio_features <- get_track_audio_features(track_ids,
#                                                  authorization = access_token)
```

```{r}
#| label: scrape genius lyrics 

## chatGPT prompt: scrape lyrics from genius.com

genius_access_token <- "W28ITauMuo8HwVUStqe7xzv0EepDLZm3rHvYkkAHyhrp-0Y-FSdm7GDqFqCYS-fA"

## pre-allocate space
playlist_lyrics <- tibble(track_name = rep(NA_character_, 100),
                          track_id = rep(NA_real_, 100),
                          lyrics = rep(NA_character_, 100))

## attempt for just one
## ACCESS TOKEN IS WRONG
  song_title <- playlist$track.name[3]
  search_song <- GET("https://api.genius.com/search",
                     query = list(q = song_title),
                     add_headers(Authorization = paste("Bearer", genius_access_token)))
  song_info <- content(search_song, as = "parsed", type = "application/json")
  song_url <- song_info$response$hits[[1]]$result$url
  lyrics <- read_html(song_url) |>
    html_nodes(".hiRbsH") |>
    html_text2()
  
  print(song_url)
  
  # add to dataset
  playlist_lyrics$track_name[1] <- song_title
  playlist_lyrics$track_id[1] <- playlist$track.id[1]
  playlist_lyrics$lyrics[1] <- lyrics

## iterate through to get lyrics
for (i in 1:100){
  # scrape lyrics
  song_title <- playlist$track.name[i]
  search_song <- GET("https://api.genius.com/search",
                     query = list(q = song_title),
                     add_headers(Authorization = paste("Bearer", genius_access_token)))
  song_info <- content(search_song, as = "parsed", type = "application/json")
  song_url <- song_info$search_song$hits[[1]]$result$url
  lyrics <- read_html(song_url) |>
    html_nodes(".lyrics") |>
    html_text2()
  
  # add to dataset
  playlist_lyrics[i]$track_name <- song_title
  playlist_lyrics[i]$track_id <- playlist$track.id[i]
  playlist_lyrics[i]$lyrics <- lyrics
}
```

```{r}
#| label: wrangling for 


```

```{r}
#| label: wrangling for 

         
```

```{r}
#| label: save final objects


```

## Sources
